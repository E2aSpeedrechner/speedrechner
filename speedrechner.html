<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Speedrechner – Polizei GAL E2a</title>

<style>
  body{
    font-family: Arial, sans-serif;
    text-align:center;
    margin-top:60px;
  }

  #hint{
    position:fixed;
    left:10px;
    top:10px;
    font-size:13px;
    color:#555;
  }

  .btn{
    font-size:16px;
    padding:18px 36px;
    cursor:pointer;
  }

  #restart{
    position:fixed;
    left:10px;
    top:34px;
  }

  #pdfBtn{
    position:fixed;
    right:10px;
    top:10px;
    display:none;
  }

  #titlePractice{
    font-weight:bold;
    color:#7a0000;
    font-size:56px;
    margin:0 0 50px 0;
  }

  .zahl{
    font-size:60px;
    margin:10px;
  }

  #eingabe{
    font-size:26px;
    width:70px;
    text-align:center;
    margin-top:30px;
  }

  #info{
    margin-top:30px;
    font-size:16px;
    min-height:22px;
  }

  .green{ color:green; }
  .red{ color:red; }

  #statistik{
    width:900px;
    margin:0 auto;
    display:none;
  }

  canvas{
    margin-top:10px;
    border:1px solid #ccc;
  }

  h2{
    color:#007acc;
    font-weight:bold;
    font-size:28px;
    margin:0 0 10px 0;
  }

  h3{
    color:#007acc;
    font-weight:bold;
    font-size:20px;
    margin:0;
  }

  #spacerStats{ height:18px; }
</style>
</head>

<body>

<div id="hint">ESC = Abbrechen</div>
<button id="restart" class="btn" onclick="location.reload()">Neu starten</button>
<button id="pdfBtn" class="btn">Ergebnis als PDF herunterladen</button>

<div id="practice">
  <div id="titlePractice">Speedrechner</div>

  <div id="oben" class="zahl"></div>
  <div id="plus" class="zahl">+</div>
  <div id="unten" class="zahl"></div>

  <input id="eingabe" type="number" maxlength="1" inputmode="numeric" autofocus>
  <div id="info"></div>
</div>

<div id="statistik">
  <h3>Geschwindigkeit</h3>
  <canvas id="chart" width="900" height="340"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
const TESTDAUER = 20 * 60;    // 1200s
const BUCKET_SEC = 10;        // 10s Auflösung
const TOTAL_SEC = TESTDAUER;  // für Klarheit

let startzeit = null;
let timerStarted = false;

let richtig = 0;
let falsch = 0;
let ersteRunde = true;

let aktuelleZahl = zufall();
let gemerkteZahl = zufall();
let eingabeZeiten = [];

const oben = document.getElementById("oben");
const unten = document.getElementById("unten");
const plus = document.getElementById("plus");
const eingabe = document.getElementById("eingabe");
const info = document.getElementById("info");

const statistik = document.getElementById("statistik");
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const pdfBtn = document.getElementById("pdfBtn");

oben.textContent = aktuelleZahl;
unten.textContent = gemerkteZahl;

eingabe.addEventListener("input", () => {
  if (eingabe.value.length === 1) pruefen();
});

document.addEventListener("keydown", e => {
  if (e.key === "Escape") ende(true);
});

function zufall(){
  return Math.floor(Math.random() * 9) + 1;
}

function starteTimer(){
  if (!timerStarted){
    timerStarted = true;
    startzeit = Date.now();
  }
}

function pruefen(){
  const wert = parseInt(eingabe.value);
  if (isNaN(wert)) return;

  starteTimer();
  eingabeZeiten.push(Date.now());

  const korrekt = (aktuelleZahl + gemerkteZahl) % 10;
  wert === korrekt ? richtig++ : falsch++;

  if (ersteRunde){
    unten.style.visibility = "hidden";
    plus.style.visibility = "hidden";
    ersteRunde = false;
  }

  gemerkteZahl = aktuelleZahl;
  aktuelleZahl = zufall();
  oben.textContent = aktuelleZahl;

  eingabe.value = "";
  updateInfo();
}

function updateInfo(){
  if (!timerStarted){
    info.innerHTML = `Zeit: 20:00 | Richtig: <span class="green">${richtig}</span> | Falsch: <span class="red">${falsch}</span>`;
    return;
  }

  const vergangen = Math.floor((Date.now() - startzeit) / 1000);
  const rest = Math.max(0, TESTDAUER - vergangen);

  const min = String(Math.floor(rest / 60)).padStart(2,"0");
  const sec = String(rest % 60).padStart(2,"0");

  info.innerHTML = `Zeit: ${min}:${sec} | Richtig: <span class="green">${richtig}</span> | Falsch: <span class="red">${falsch}</span>`;
  if (rest === 0) ende(false);
}

/* erzeugt IMMER volle 20 Minuten in 10s-Buckets (0..1200) */
function berechneSpeedSerie(abbruch){
  // 0..1200 in 10s Schritten => 121 Punkte
  const keys = [];
  for (let s = 0; s <= TOTAL_SEC; s += BUCKET_SEC) keys.push(s);

  // counts pro bucket
  const counts = {};
  keys.forEach(k => counts[k] = 0);

  if (timerStarted && eingabeZeiten.length > 0){
    for (const t of eingabeZeiten){
      const sec = Math.floor((t - startzeit) / 1000);
      const b = Math.min(TOTAL_SEC, Math.floor(sec / BUCKET_SEC) * BUCKET_SEC);
      counts[b] = (counts[b] || 0) + 1;
    }
  }

  // pro Minute hochrechnen
  const speed = keys.map(k => (counts[k] || 0) * (60 / BUCKET_SEC));

  // Wenn abgebrochen: ab letzter Eingabe waagrecht bis Ende
  if (abbruch && timerStarted && eingabeZeiten.length > 0){
    const lastInputSec = Math.min(TOTAL_SEC, Math.floor((Math.max(...eingabeZeiten) - startzeit) / 1000));
    const lastBucket = Math.floor(lastInputSec / BUCKET_SEC) * BUCKET_SEC;
    const lastIdx = keys.indexOf(lastBucket);
    const lastSpeed = speed[lastIdx] ?? 0;

    for (let i = lastIdx + 1; i < speed.length; i++){
      speed[i] = lastSpeed;
    }
  }

  return { keys, speed };
}

function zeichneKurve(keys, speed){
  statistik.style.display = "block";
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const pad = 55;

  // maxY runden (für schönere Achse) – mindestens 10
  let maxY = Math.max(...speed, 10);
  maxY = Math.ceil(maxY / 10) * 10;

  ctx.font = "bold 12px Arial";

  // Achsentitel
  ctx.fillText("Zeit (Minute)", pad, canvas.height - 10);
  ctx.fillText("Eingaben / Minute", canvas.width - 170, pad - 20);

  // X Raster: alle 10s, Labels nur jede 1 Minute
  ctx.strokeStyle = "#eee";
  for (let i = 0; i < keys.length; i++){
    const sec = keys[i];
    const x = pad + i * ((canvas.width - 2*pad) / (keys.length - 1));

    ctx.beginPath();
    ctx.moveTo(x, pad);
    ctx.lineTo(x, canvas.height - pad);
    ctx.stroke();

    if (sec % 60 === 0){
      ctx.fillText(String(sec / 60), x - 4, canvas.height - pad + 18);
    }
  }

  // Y Raster: 10er Schritte (übersichtlich)
  for (let y=0; y<=maxY; y+=10){
    const py = canvas.height - pad - (y / maxY) * (canvas.height - 2*pad);
    ctx.beginPath();
    ctx.moveTo(pad, py);
    ctx.lineTo(canvas.width - pad, py);
    ctx.stroke();
    ctx.fillText(y, canvas.width - pad + 8, py + 4);
  }

  // Kurve
  ctx.beginPath();
  ctx.strokeStyle="#007acc";
  ctx.lineWidth=2;
  ctx.lineJoin="round";
  ctx.lineCap="round";

  for (let i = 0; i < speed.length; i++){
    const x = pad + i * ((canvas.width - 2*pad) / (speed.length - 1));
    const y = canvas.height - pad - (speed[i] / maxY) * (canvas.height - 2*pad);
    if (i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function ende(abbruch
