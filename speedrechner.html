<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Speedrechner – Polizei GAL E2a</title>

<style>
  body{
    font-family: Arial, sans-serif;
    text-align:center;
    margin-top:60px;
  }

  #hint{
    position:fixed;
    left:10px;
    top:10px;
    font-size:13px;
    color:#555;
  }

  /* Buttons groß */
  .btn{
    font-size:16px;
    padding:18px 36px;
    cursor:pointer;
  }

  #restart{
    position:fixed;
    left:10px;
    top:34px;
  }

  #pdfBtn{
    position:fixed;
    right:10px;
    top:10px;
    display:none; /* nur in Auswertung */
  }

  /* Übungs-Header */
  #titlePractice{
    font-weight:bold;
    color:#7a0000;
    font-size:56px;
    margin:0 0 50px 0;
  }

  .zahl{
    font-size:60px;
    margin:10px;
    min-height:72px; /* stabilisiert Layout */
  }

  #eingabe{
    font-size:26px;
    width:70px;
    text-align:center;
    margin-top:30px;
  }

  #info{
    margin-top:30px;
    font-size:16px;
    min-height:22px;
  }

  .green{ color:green; }
  .red{ color:red; }

  #statistik{
    width:900px;
    margin:0 auto;
    display:none;
  }

  canvas{
    margin-top:10px;
    border:1px solid #ccc;
  }

  h2{
    color:#007acc;
    font-weight:bold;
    font-size:28px;
    margin:0 0 10px 0;
  }

  h3{
    color:#007acc;
    font-weight:bold;
    font-size:20px;
    margin:0;
  }

  #spacerStats{ height:18px; }

  /* Legende */
  #legend{
    margin-top:8px;
    font-size:14px;
    font-weight:bold;
    display:flex;
    justify-content:center;
    gap:18px;
    align-items:center;
  }
  .legend-item{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .swatch{
    width:18px;
    height:4px;
    border-radius:2px;
    display:inline-block;
  }
</style>
</head>

<body>

<div id="hint">ESC = Abbrechen</div>
<button id="restart" class="btn" onclick="location.reload()">Neu starten</button>
<button id="pdfBtn" class="btn">Ergebnis als PDF herunterladen</button>

<div id="practice">
  <div id="titlePractice">Speedrechner</div>

  <div id="oben" class="zahl"></div>
  <div id="plus" class="zahl">+</div>
  <div id="unten" class="zahl"></div>

  <input id="eingabe" type="number" maxlength="1" inputmode="numeric" autofocus>
  <div id="info"></div>
</div>

<div id="statistik">
  <h3>Geschwindigkeit</h3>
  <canvas id="chart" width="900" height="340"></canvas>

  <div id="legend">
    <div class="legend-item"><span class="swatch" style="background:#007acc;"></span>Tempo pro Minute</div>
    <div class="legend-item"><span class="swatch" style="background:#e67e22;"></span>Gleitender Gesamtdurchschnitt</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* ---------------- Einstellungen ---------------- */
  const TESTDAUER_SEC = 20 * 60;     // 1200 Sekunden
  const TOTAL_MIN = 20;             // immer 20 Minuten im Diagramm
  /* ----------------------------------------------- */

  // Timer startet erst ab erster Eingabe
  let startzeit = null;
  let timerStarted = false;

  let richtig = 0;
  let falsch = 0;
  let ersteRunde = true;

  let aktuelleZahl = zufall();
  let gemerkteZahl = zufall();
  let eingabeZeiten = [];

  const practice = document.getElementById("practice");
  const oben = document.getElementById("oben");
  const unten = document.getElementById("unten");
  const plus = document.getElementById("plus");
  const eingabe = document.getElementById("eingabe");
  const info = document.getElementById("info");

  const statistik = document.getElementById("statistik");
  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");
  const pdfBtn = document.getElementById("pdfBtn");

  let letzteAuswertung = null;

  // Sicher initial sichtbar
  plus.style.visibility = "visible";
  unten.style.visibility = "visible";
  plus.style.display = "block";
  unten.style.display = "block";

  // Initialanzeige
  oben.textContent = String(aktuelleZahl);
  unten.textContent = String(gemerkteZahl);

  // Sofort prüfen bei 1 Ziffer
  eingabe.addEventListener("input", () => {
    if (eingabe.value.length === 1) pruefen();
  });

  // ESC abbrechen
  document.addEventListener("keydown", e => {
    if (e.key === "Escape") ende(true);
  });

  function zufall(){
    return Math.floor(Math.random() * 9) + 1;
  }

  function starteTimer(){
    if (!timerStarted){
      timerStarted = true;
      startzeit = Date.now();
    }
  }

  function pruefen(){
    const wert = parseInt(eingabe.value, 10);
    if (Number.isNaN(wert)) return;

    starteTimer();
    eingabeZeiten.push(Date.now());

    const korrekt = (aktuelleZahl + gemerkteZahl) % 10;
    (wert === korrekt) ? richtig++ : falsch++;

    // nach erster Eingabe: unsichtbar, aber Platz bleibt (kein Springen)
    if (ersteRunde){
      unten.style.visibility = "hidden";
      plus.style.visibility = "hidden";
      ersteRunde = false;
    }

    gemerkteZahl = aktuelleZahl;
    aktuelleZahl = zufall();
    oben.textContent = String(aktuelleZahl);

    eingabe.value = "";
    updateInfo();
  }

  function updateInfo(){
    if (!timerStarted){
      info.innerHTML =
        `Zeit: 20:00 | ` +
        `Richtig: <span class="green">${richtig}</span> | ` +
        `Falsch: <span class="red">${falsch}</span>`;
      return;
    }

    const vergangen = Math.floor((Date.now() - startzeit) / 1000);
    const rest = Math.max(0, TESTDAUER_SEC - vergangen);

    const min = String(Math.floor(rest / 60)).padStart(2,"0");
    const sec = String(rest % 60).padStart(2,"0");

    info.innerHTML =
      `Zeit: ${min}:${sec} | ` +
      `Richtig: <span class="green">${richtig}</span> | ` +
      `Falsch: <span class="red">${falsch}</span>`;

    if (rest === 0) ende(false);
  }

  /* ----------- Statistik: pro Minute (60s) ----------- */

  // Ergebnisserie: 20 Minuten (0..19) + X-Achse zeigt 0..20
  function berechneSpeedSerieProMinute(abbruch){
    const minuten = [];
    for (let
