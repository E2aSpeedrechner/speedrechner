<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Speedrechner – Polizei GAL E2a</title>

<style>
  body{
    font-family: Arial, sans-serif;
    text-align:center;
    margin-top:60px;
  }

  #hint{
    position:fixed;
    left:10px;
    top:10px;
    font-size:13px;
    color:#555;
  }

  .btn{
    font-size:16px;
    padding:18px 36px;
    cursor:pointer;
  }

  #restart{ position:fixed; left:10px; top:34px; }
  #pdfBtn{ position:fixed; right:10px; top:10px; display:none; }

  #titlePractice{
    font-weight:bold;
    color:#7a0000;
    font-size:56px;
    margin:0 0 50px 0;
  }

  .zahl{
    font-size:60px;
    margin:10px;
    min-height:72px;
  }

  /* NEUTRALES FEEDBACK */
  #oben{
    display:inline-block;
    padding:4px 18px;
    border-radius:14px;
    transition: box-shadow 120ms ease, transform 120ms ease;
  }
  .flash-neutral{
    box-shadow: 0 0 0 3px rgba(120,120,120,0.35);
    transform: scale(1.02);
  }

  #eingabe{
    font-size:26px;
    width:70px;
    text-align:center;
    margin-top:30px;
    border:2px solid #999;
    border-radius:10px;
    outline:none;
    transition: box-shadow 120ms ease;
  }
  .input-neutral{
    box-shadow: 0 0 0 4px rgba(120,120,120,0.18);
  }

  #info{
    margin-top:30px;
    font-size:16px;
    min-height:22px;
  }

  .green{ color:green; }
  .red{ color:red; }

  #statistik{
    width:900px;
    margin:0 auto;
    display:none;
  }

  canvas{
    margin-top:10px;
    border:1px solid #ccc;
  }

  h2{ color:#007acc; font-weight:bold; font-size:28px; }
  h3{ color:#007acc; font-weight:bold; font-size:20px; }

  #legend{
    margin-top:8px;
    font-size:14px;
    font-weight:bold;
    display:flex;
    justify-content:center;
    gap:18px;
  }
  .legend-item{ display:flex; gap:8px; align-items:center; }
  .swatch{ width:18px; height:4px; border-radius:2px; }
</style>
</head>

<body>

<div id="hint">ESC = Abbrechen</div>
<button id="restart" class="btn" onclick="location.reload()">Neu starten</button>
<button id="pdfBtn" class="btn">Ergebnis als PDF herunterladen</button>

<div id="practice">
  <div id="titlePractice">Speedrechner</div>

  <div id="oben" class="zahl"></div>
  <div id="plus" class="zahl">+</div>
  <div id="unten" class="zahl"></div>

  <input id="eingabe" type="number" maxlength="1" inputmode="numeric" autofocus>
  <div id="info"></div>
</div>

<div id="statistik">
  <h3>Geschwindigkeit</h3>
  <canvas id="chart" width="900" height="340"></canvas>

  <div id="legend">
    <div class="legend-item"><span class="swatch" style="background:#007acc;"></span>Tempo / Minute</div>
    <div class="legend-item"><span class="swatch" style="background:#e67e22;"></span>Gesamtdurchschnitt</div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const TOTAL_MIN = 20;
  let startzeit = null, timerStarted = false;
  let richtig = 0, falsch = 0, ersteRunde = true;
  let aktuelleZahl = 0, gemerkteZahl = 0, eingabeZeiten = [];

  const oben = document.getElementById("oben");
  const unten = document.getElementById("unten");
  const plus  = document.getElementById("plus");
  const eingabe = document.getElementById("eingabe");
  const info = document.getElementById("info");

  function zufall(){ return Math.floor(Math.random()*9)+1; }

  function initAufgabe(){
    aktuelleZahl = zufall();
    gemerkteZahl = zufall();
    oben.textContent = aktuelleZahl;
    unten.textContent = gemerkteZahl;
    plus.style.visibility = "visible";
    unten.style.visibility = "visible";
    ersteRunde = true;
  }

  initAufgabe();

  function starteTimer(){
    if(!timerStarted){
      timerStarted = true;
      startzeit = Date.now();
    }
  }

  function neutralFlash(){
    oben.classList.remove("flash-neutral");
    eingabe.classList.remove("input-neutral");

    // Reflow erzwingen für sicheres erneutes Triggern
    void oben.offsetWidth;

    oben.classList.add("flash-neutral");
    eingabe.classList.add("input-neutral");

    setTimeout(()=>{
      oben.classList.remove("flash-neutral");
      eingabe.classList.remove("input-neutral");
    },120);
  }

  eingabe.addEventListener("input",()=>{
    if(eingabe.value.length===1){
      const wert = parseInt(eingabe.value,10);
      if(isNaN(wert)) return;

      starteTimer();
      eingabeZeiten.push(Date.now());

      const korrekt = (aktuelleZahl + gemerkteZahl) % 10;
      korrekt===wert ? richtig++ : falsch++;

      neutralFlash();

      if(ersteRunde){
        unten.style.visibility="hidden";
        plus.style.visibility="hidden";
        ersteRunde=false;
      }

      gemerkteZahl = aktuelleZahl;
      aktuelleZahl = zufall();
      oben.textContent = aktuelleZahl;

      eingabe.value="";
      updateInfo();
    }
  });

  function updateInfo(){
    info.innerHTML =
      `Richtig: <span class="green">${richtig}</span> | ` +
      `Falsch: <span class="red">${falsch}</span>`;
  }

  updateInfo();
});
</script>

</body>
</html>
